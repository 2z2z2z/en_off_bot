# Рефакторинг

Исходный аудит: `refactor-plan.md`.

## План

- [x] 1. Race condition в обработке очереди ответов — добавил флаг `isProcessingQueue` и гарантированное снятие блокировки после цикла.
- [x] 2. Безопасность: пароли в открытом виде — внедрил AES-256-GCM с обязательным `ENCRYPTION_KEY`, шифрую при сохранении и расшифровываю при загрузке.
- [x] 3. Memory leak в messageUpdateThrottle — ввёл TTL с автоочисткой Map и сбросом таймеров.
- [x] 4. Telegram rate limiting не обрабатывается для больших очередей — уменьшил частоту обновления прогресса очереди, добавил батчирование и форс-обновления для ошибок.
- [x] 5. Race condition в Encounter API rate limiter — заменил запись времени на Promise-очередь с последовательным выполнением.
- [x] 6. Кеш уровней не thread-safe для одной игры — расширил ключи кеша до domain+game+login и научил инвалидировать весь кеш игры при смене уровня.
- [x] 7. Обработка очереди прерывается на неизвестной ошибке — ввёл ограниченные повторные попытки, веду счётчик ошибок и продолжаю обработку оставшихся ответов.
