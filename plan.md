# Рефакторинг

Исходный аудит: `refactor-plan.md`.

## План

- [ ] Добавить блокировку `isProcessingQueue` для избежания параллельной обработки очередей ответов (см. refactor-plan.md, раздел «Race condition в обработке очереди ответов»)
- [ ] Реализовать шифрование паролей Encounter (AES-256, ключ `ENCRYPTION_KEY`) и миграцию существующих записей (см. «Безопасность: пароли в открытом виде»)
- [ ] Ограничить рост `messageUpdateThrottle`, очищать записи после завершения работы или при достижении лимита (см. «Memory leak в messageUpdateThrottle»)
- [ ] Нормализовать пользовательские ответы по платформам (приведение к строке, trim, ограничить длину) (см. «Ответы пользователя не нормализованы»)
- [ ] Хранить таймшифты Encounter уровней в конфигурации/кеше, избегая повторных запросов (см. «Лишние запросы Encounter API»)
- [ ] Перевести ALLOWED_COMMANDS/клавиатуры в конфигурацию `config/commands.js` и унифицировать (см. «Расхождения в командах Telegram/VK»)
- [ ] Вынести magic numbers в `config/defaults.js` и использовать константы (см. блок «Magic numbers в index.js»)
- [ ] Подготовить модуль централизованного логирования, заменить `console.log`/`console.error` на уровни логов (см. «Логирование через console.*»)
- [ ] Стандартизировать обработку ошибок и ретраев для Encounter API (использовать единый код с лимитом попыток) (см. «Повторяющийся код обработки ошибок Encounter API»)
- [ ] Задокументировать и добавить unit-тесты для core (user-store, answer-service, messenger) согласно рекомендациям ревью (см. раздел «⚪ Улучшения для следующего релиза», п.3)
